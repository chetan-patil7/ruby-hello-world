---
- name: Smart Tool Verification and Installation
  hosts: webservers
  become: yes
  vars:
    force_installation: "{{ force_tool_installation | default(false) }}"
    deploy_user: "{{ ansible_user }}"
  
  tasks:
    - name: Create tool check directory
      file:
        path: /tmp/tool_check
        state: directory
        mode: '0755'
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"

    - name: Smart tool audit script
      copy:
        dest: /tmp/smart_audit.sh
        mode: '0755'
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        content: |
          #!/bin/bash
          echo "ğŸ” SMART SERVER TOOL AUDIT"
          echo "==========================="
          echo "Date: $(date)"
          echo "Server: $(hostname)"
          echo "Force installation: {{ force_installation }}"
          echo ""
          
          # Initialize tracking
          MISSING_PACKAGES=""
          INSTALL_REQUIRED=false
          
          echo "ğŸ“¦ SYSTEM PACKAGES AUDIT:"
          echo "========================"
          
          # Check each package individually
          for pkg in curl wget git build-essential python3 unzip; do
            if dpkg -l 2>/dev/null | grep -q "^ii.*$pkg "; then
              echo "  âœ… $pkg - installed (SKIP)"
            else
              echo "  âŒ $pkg - MISSING (WILL INSTALL)"
              MISSING_PACKAGES="$MISSING_PACKAGES $pkg"
              INSTALL_REQUIRED=true
            fi
          done
          
          # Check PostgreSQL
          if dpkg -l 2>/dev/null | grep -q "^ii.*postgresql"; then
            echo "  âœ… postgresql - installed (SKIP)"
          else
            echo "  âŒ postgresql - MISSING (WILL INSTALL)"
            MISSING_PACKAGES="$MISSING_PACKAGES postgresql postgresql-contrib"
            INSTALL_REQUIRED=true
          fi
          
          # Check redis-server
          if dpkg -l 2>/dev/null | grep -q "^ii.*redis-server"; then
            echo "  âœ… redis-server - installed (SKIP)"
          else
            echo "  âŒ redis-server - MISSING (WILL INSTALL)"
            MISSING_PACKAGES="$MISSING_PACKAGES redis-server"
            INSTALL_REQUIRED=true
          fi
          
          # Check imagemagick
          if dpkg -l 2>/dev/null | grep -q "^ii.*imagemagick"; then
            echo "  âœ… imagemagick - installed (SKIP)"
          else
            echo "  âŒ imagemagick - MISSING (WILL INSTALL)"
            MISSING_PACKAGES="$MISSING_PACKAGES imagemagick"
            INSTALL_REQUIRED=true
          fi
          
          echo ""
          echo "ğŸ’ RUBY ENVIRONMENT AUDIT:"
          echo "========================="
          
          if [ -d "/home/{{ deploy_user }}/.rbenv" ]; then
            echo "  âœ… rbenv - installed (SKIP)"
          else
            echo "  âŒ rbenv - NOT INSTALLED (WILL INSTALL)"
            INSTALL_REQUIRED=true
          fi
          
          if command -v ruby >/dev/null 2>&1; then
            RUBY_VERSION=$(ruby --version)
            echo "  âœ… Ruby - $RUBY_VERSION (SKIP)"
          else
            echo "  âŒ Ruby - NOT INSTALLED (WILL INSTALL)"
            INSTALL_REQUIRED=true
          fi
          
          if command -v bundle >/dev/null 2>&1; then
            BUNDLER_VERSION=$(bundle --version)
            echo "  âœ… Bundler - $BUNDLER_VERSION (SKIP)"
          else
            echo "  âŒ Bundler - NOT INSTALLED (WILL INSTALL)"
            INSTALL_REQUIRED=true
          fi
          
          echo ""
          echo "ğŸŸ¢ NODE.JS ENVIRONMENT AUDIT:"
          echo "============================"
          
          if command -v node >/dev/null 2>&1; then
            NODE_VERSION=$(node --version)
            echo "  âœ… Node.js - $NODE_VERSION (SKIP)"
          else
            echo "  âŒ Node.js - NOT INSTALLED (WILL INSTALL)"
            INSTALL_REQUIRED=true
          fi
          
          if command -v npm >/dev/null 2>&1; then
            NPM_VERSION=$(npm --version)
            echo "  âœ… npm - $NPM_VERSION (SKIP)"
          else
            echo "  âŒ npm - NOT INSTALLED (WILL INSTALL)"
            INSTALL_REQUIRED=true
          fi
          
          echo ""
          echo "ğŸ˜ POSTGRESQL AUDIT:"
          echo "==================="
          
          if command -v psql >/dev/null 2>&1; then
            PSQL_VERSION=$(psql --version)
            echo "  âœ… PostgreSQL client - $PSQL_VERSION (SKIP)"
          else
            echo "  âŒ PostgreSQL client - NOT INSTALLED (WILL INSTALL)"
            INSTALL_REQUIRED=true
          fi
          
          if systemctl is-active postgresql >/dev/null 2>&1; then
            echo "  âœ… PostgreSQL service - RUNNING (SKIP)"
          else
            echo "  âŒ PostgreSQL service - NOT RUNNING (WILL CONFIGURE)"
            INSTALL_REQUIRED=true
          fi
          
          echo ""
          echo "ğŸ“‹ SMART AUDIT SUMMARY:"
          echo "======================"
          
          if [ "$INSTALL_REQUIRED" = "true" ] || [ "{{ force_installation }}" = "true" ]; then
            echo "ğŸ”§ INSTALLATION REQUIRED"
            echo "Missing packages: $MISSING_PACKAGES"
            echo "INSTALL_REQUIRED" > /tmp/tool_check/status
          else
            echo "âœ… ALL TOOLS ALREADY INSTALLED"
            echo "No installation needed"
            echo "TOOLS_READY" > /tmp/tool_check/status
          fi
          
          echo "$MISSING_PACKAGES" > /tmp/tool_check/missing_packages

    - name: Execute smart tool audit
      shell: /tmp/smart_audit.sh
      register: tool_audit
      become_user: "{{ deploy_user }}"

    - name: Display audit results
      debug:
        msg: "{{ tool_audit.stdout_lines }}"

    - name: Read tool status
      shell: cat /tmp/tool_check/status
      register: tool_status
      ignore_errors: yes

    - name: Read missing packages list
      shell: cat /tmp/tool_check/missing_packages
      register: missing_packages
      ignore_errors: yes

    - name: Update package cache
      apt:
        update_cache: yes
      when: 
        - tool_status.stdout == "INSTALL_REQUIRED" or force_installation|bool
        - missing_packages.stdout is defined
        - missing_packages.stdout | trim | length > 0

    - name: Install missing system packages
      apt:
        name: "{{ missing_packages.stdout.split() }}"
        state: present
      when: 
        - tool_status.stdout == "INSTALL_REQUIRED" or force_installation|bool
        - missing_packages.stdout is defined
        - missing_packages.stdout | trim | length > 0

    - name: Setup Ruby environment (rbenv)
      block:
        - name: Check if rbenv installation needed
          stat:
            path: "/home/{{ deploy_user }}/.rbenv"
          register: rbenv_check

        - name: Install rbenv
          shell: |
            echo "ğŸ’ Installing rbenv..."
            git clone https://github.com/rbenv/rbenv.git /home/{{ deploy_user }}/.rbenv
            git clone https://github.com/rbenv/ruby-build.git /home/{{ deploy_user }}/.rbenv/plugins/ruby-build
            
            # Add to bashrc if not present
            if ! grep -q 'rbenv' /home/{{ deploy_user }}/.bashrc; then
              echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> /home/{{ deploy_user }}/.bashrc
              echo 'eval "$(rbenv init -)"' >> /home/{{ deploy_user }}/.bashrc
            fi
            
            chown -R {{ deploy_user }}:{{ deploy_user }} /home/{{ deploy_user }}/.rbenv
          when: not rbenv_check.stat.exists or force_installation|bool
          become_user: root

        - name: Install Ruby
          shell: |
            export PATH="/home/{{ deploy_user }}/.rbenv/bin:$PATH"
            eval "$(rbenv init -)"
            
            if ! command -v ruby >/dev/null 2>&1 || [ "{{ force_installation }}" = "true" ]; then
              echo "Installing Ruby 3.1.3..."
              rbenv install 3.1.3
              rbenv global 3.1.3
              rbenv rehash
              
              # Install bundler
              gem install bundler
              rbenv rehash
              
              echo "âœ… Ruby and Bundler installed"
            else
              echo "âœ… Ruby already installed"
            fi
          become_user: "{{ deploy_user }}"
          environment:
            PATH: "/home/{{ deploy_user }}/.rbenv/bin:/home/{{ deploy_user }}/.rbenv/shims:{{ ansible_env.PATH }}"
          args:
            executable: /bin/bash
      when: tool_status.stdout == "INSTALL_REQUIRED" or force_installation|bool

    - name: Setup Node.js
      shell: |
        if ! command -v node >/dev/null 2>&1 || [ "{{ force_installation }}" = "true" ]; then
          echo "ğŸŸ¢ Installing Node.js..."
          curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
          apt-get install -y nodejs
          echo "âœ… Node.js installed"
        else
          echo "âœ… Node.js already installed"
        fi
      when: tool_status.stdout == "INSTALL_REQUIRED" or force_installation|bool

    - name: Configure PostgreSQL
      block:
        - name: Start and enable PostgreSQL service
          systemd:
            name: postgresql
            state: started
            enabled: yes

        - name: Check if PostgreSQL user exists
          shell: sudo -u postgres psql -c "\du" | grep -q "{{ deploy_user }}"
          register: pg_user_check
          ignore_errors: yes

        - name: Create PostgreSQL user
          shell: |
            sudo -u postgres createuser --createdb {{ deploy_user }}
            sudo -u postgres psql -c "ALTER USER {{ deploy_user }} WITH PASSWORD 'deploy123';"
          when: pg_user_check.rc != 0
          ignore_errors: yes

        - name: Test PostgreSQL connection
          shell: psql -U {{ deploy_user }} -h localhost -c "SELECT version();" postgres
          become_user: "{{ deploy_user }}"
          environment:
            PGPASSWORD: "deploy123"
          ignore_errors: yes
      when: tool_status.stdout == "INSTALL_REQUIRED" or force_installation|bool

    - name: Start Redis service
      systemd:
        name: redis-server
        state: started
        enabled: yes
      when: tool_status.stdout == "INSTALL_REQUIRED" or force_installation|bool
      ignore_errors: yes

    - name: Final verification
      shell: |
        echo "ğŸ” FINAL VERIFICATION"
        echo "===================="
        echo "Ruby: $(ruby --version 2>/dev/null || echo 'Not available')"
        echo "Bundler: $(bundle --version 2>/dev/null || echo 'Not available')"
        echo "Node.js: $(node --version 2>/dev/null || echo 'Not available')"
        echo "npm: $(npm --version 2>/dev/null || echo 'Not available')"
        echo "PostgreSQL: $(psql --version 2>/dev/null || echo 'Not available')"
        echo "Redis: $(redis-server --version 2>/dev/null | head -1 || echo 'Not available')"
        echo "ImageMagick: $(convert --version 2>/dev/null | head -1 || echo 'Not available')"
        
        echo ""
        echo "âœ… TOOL VERIFICATION COMPLETED"
        echo "ğŸ¯ Server ready for Rails deployment"
        echo "READY" > /tmp/tool_check/final_status
      become_user: "{{ deploy_user }}"
      environment:
        PATH: "/home/{{ deploy_user }}/.rbenv/bin:/home/{{ deploy_user }}/.rbenv/shims:{{ ansible_env.PATH }}"
      args:
        executable: /bin/bash

    - name: Display success message
      debug:
        msg: |
          ğŸ‰ TOOL VERIFICATION COMPLETED! ğŸ‰
          
          âœ… Smart installation logic applied
          âœ… Only missing tools were installed  
          âœ… Existing tools were preserved
          âœ… Server ready for Rails deployment
          
          ğŸ’¡ Installed Tools:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ”§ System packages (curl, wget, git, build-essential, etc.)
          ğŸ’ Ruby environment (rbenv, Ruby 3.1.3, Bundler)
          ğŸŸ¢ Node.js and npm
          ğŸ˜ PostgreSQL with deploy user
          ğŸ”´ Redis server
          ğŸ–¼ï¸  ImageMagick

    - name: Cleanup temporary files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/smart_audit.sh
        - /tmp/tool_check
      ignore_errors: yes