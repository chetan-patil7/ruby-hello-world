---
- name: Deploy Rails Application
  hosts: all
  become: yes
  vars:
    app_user: "deploy"
    app_path: "/var/www/hello-world-app"
    # rails_env will be passed from Jenkins as extra-vars
    
  tasks:
    - name: Display deployment information
      debug:
        msg: |
          ğŸš€ DEPLOYMENT STARTING ğŸš€
          Deploying to: {{ inventory_hostname }}
          Rails Environment: {{ rails_env }}
          Branch: {{ branch_name }}
          App Path: {{ app_path }}
          Git Repo: {{ git_repo_url }}
          Deploy Type: {{ deploy_type | default('UNKNOWN') }}
          
    # - name: Remove application directory completely
    #   file:
    #     path: "{{ app_path }}"
    #     state: absent

    # - name: Create fresh application directory
    #   file:
    #     path: "{{ app_path }}"
    #     state: directory
    #     owner: "{{ app_user }}"
    #     group: "{{ app_user }}"
    #     mode: '0755'
    
    # - name: Deploy latest code from repository (clean slate)
    #   git:
    #     repo: "{{ git_repo_url }}"
    #     dest: "{{ app_path }}"
    #     version: "{{ branch_name }}"
    #     force: yes
    #   become_user: "{{ app_user }}"
    #   register: git_result

    # - name: Display deployment result
    #   debug:
    #     msg: "âœ… Code deployment completed. Changed: {{ git_result.changed }}"

    # - name: Install Ruby gems
    #   shell: "bundle install --deployment --without development test"
    #   args:
    #     chdir: "{{ app_path }}"
    #   become_user: "{{ app_user }}"
    #   environment:
    #     RAILS_ENV: "{{ rails_env }}"
    #   ignore_errors: yes
    #   register: bundle_result
      
    # - name: Display bundle install result
    #   debug:
    #     msg: "ğŸ“¦ Bundle install completed: {{ bundle_result.changed | default('failed') }}"
    
    - name: Run database migrations
      shell: "RAILS_ENV={{ rails_env }} bundle exec rake db:migrate"
      args:
        chdir: "{{ app_path }}"
      become_user: "{{ app_user }}"
      ignore_errors: yes
      register: migration_result
      
    - name: Display migration result
      debug:
        msg: "ğŸ—ƒï¸ Database migration completed: {{ migration_result.changed | default('failed') }}"
    
    - name: Precompile assets
      shell: "RAILS_ENV={{ rails_env }} bundle exec rake assets:precompile"
      args:
        chdir: "{{ app_path }}"
      become_user: "{{ app_user }}"
      ignore_errors: yes
      register: assets_result
      
    - name: Display assets compilation result
      debug:
        msg: "ğŸ¨ Assets precompilation completed: {{ assets_result.changed | default('failed') }}"
    
    - name: Set proper permissions
      file:
        path: "{{ app_path }}"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        recurse: yes
    
    - name: Restart Apache service
      service:
        name: apache2
        state: restarted
      ignore_errors: yes
      register: apache_result

    - name: Display Apache restart result
      debug:
        msg: "ğŸŒ Apache restart completed: {{ apache_result.changed | default('failed') }}"

    - name: Deployment Summary
      debug:
        msg: |
          ğŸ‰ DEPLOYMENT COMPLETED ğŸ‰
          Server: {{ inventory_hostname }}
          Environment: {{ rails_env }}
          Branch: {{ branch_name }}
          Status: {% if git_result.changed %}SUCCESS{% else %}PARTIAL{% endif %}
  
  handlers:
    - name: check apache status
      service:
        name: apache2
        state: started